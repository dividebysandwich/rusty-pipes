name: Rust

on:
  push:
  pull_request:

env:
  CARGO_TERM_COLOR: always

defaults:
  run:
    # necessary for windows
    shell: bash

jobs:
  test:
    runs-on: ubuntu-latest
    needs: flatpak
    steps:
      - uses: actions/checkout@v4
      
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libjack-jackd2-dev

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ./target
          key: test-cargo-registry-${{ hashFiles('Cargo.lock') }}
      - name: List
        run: find ./
      - name: Run tests
        run: cargo test --verbose

  flatpak:
    name: Build Linux Flatpak
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Flatpak Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder elfutils
          sudo flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Sdk//25.08 \
                                          org.freedesktop.Platform//25.08 \
                                          org.freedesktop.Sdk.Extension.rust-stable//25.08

      - name: Vendor Dependencies
        run: |
          mkdir -p .cargo
          cargo vendor > .cargo/config.toml

      - name: Build Flatpak
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: rusty-pipes.flatpak
          manifest-path: com.dividebysandwich.rustypipes.yml
          cache-key: flatpak-builder-${{ github.sha }}

      - name: Upload Flatpak Bundle
        uses: actions/upload-artifact@v4
        with:
          name: flatpak-bundle
          path: rusty-pipes.flatpak

  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - TARGET: x86_64-unknown-linux-gnu 
            OS: ubuntu-latest
          - TARGET: x86_64-apple-darwin
            OS: macos-latest
          - TARGET: x86_64-pc-windows-msvc
            OS: windows-latest
    needs: build-deb
    runs-on: ${{ matrix.OS }}
    env:
      NAME: rusty-pipes
      TARGET: ${{ matrix.TARGET }}
      OS: ${{ matrix.OS }}
    steps:
      - uses: actions/checkout@v4
      - name: Calculate Cargo hash
        id: cargo-hash
        run: |
          # Try sha256sum (Linux/Windows), fall back to shasum (macOS)
          if command -v sha256sum > /dev/null; then
            echo "hash=$(sha256sum Cargo.lock | awk '{print $1}')" >> $GITHUB_OUTPUT
          else
            echo "hash=$(shasum -a 256 Cargo.lock | awk '{print $1}')" >> $GITHUB_OUTPUT
          fi

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ./target
          key: build-cargo-registry-${{ matrix.TARGET }}-${{ steps.cargo-hash.outputs.hash }}
      - name: List
        run: find ./

      - name: Install dependencies
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libjack-jackd2-dev

      - name: Install rust target
        run: rustup target add $TARGET
        
      - name: Install cargo-bundle
        if: runner.os == 'macOS'
        run: cargo install cargo-bundle

      - name: Run build (Linux/Windows)
        if: runner.os != 'macOS'
        run: cargo build --release --verbose --target $TARGET

      - name: Run bundle (macOS)
        if: runner.os == 'macOS'
        run: cargo bundle --release --target $TARGET

      - name: Install zip
        if: runner.os == 'Windows'
        run: choco install zip
        
      - name: List target
        run: find ./target
        
      - name: Compress
        run: |
          mkdir -p ./artifacts
          if [[ $GITHUB_REF_TYPE =~ ^tag$ ]]; then
            TAG=$GITHUB_REF_NAME
          else
            TAG=$GITHUB_SHA
          fi

          if [[ $OS =~ ^windows.*$ ]]; then
              EXEC=$NAME.exe
              mv ./target/$TARGET/release/$EXEC ./$EXEC
              # Use 'zip' for Windows
              zip ./artifacts/$NAME-$TARGET-$TAG.zip $EXEC readme.md LICENSE
          
          elif [[ $OS =~ ^macos.*$ ]]; then
              APP_DIR="./target/$TARGET/release/bundle/osx"
              
              echo "--- Listing bundle directory contents ---"
              ls -l "$APP_DIR"
              echo "-------------------------------------------"

              # Find the .app directory name automatically
              APP_NAME_WITH_EXT=$(find "$APP_DIR" -name "*.app" -maxdepth 1 -exec basename {} \;)

              if [ -z "$APP_NAME_WITH_EXT" ]; then
                  echo "Error: No .app directory found in $APP_DIR"
                  exit 1
              fi

              echo "Found app: $APP_NAME_WITH_EXT"
              
              # Copy readme and license into the directory to get clean paths
              echo "Copying auxiliary files into bundle directory..."
              cp ./readme.md "$APP_DIR/"
              cp ./LICENSE "$APP_DIR/"
              
              echo "Zipping app from $APP_DIR"
              
              # cd into the directory containing the .app so it's at the zip root
              # Now zip the app and the local copies of the readme/license
              (cd "$APP_DIR" && zip -r -q "../../../../../artifacts/$NAME-$TARGET-$TAG.zip" "$APP_NAME_WITH_EXT" readme.md LICENSE)

          else
              EXEC=$NAME
              mv ./target/$TARGET/release/$EXEC ./$EXEC
              # Use 'tar' for Linux
              tar -czf ./artifacts/$NAME-$TARGET-$TAG.tar.gz $EXEC readme.md LICENSE
          fi
          
      - name: Archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: result-${{ matrix.TARGET }}
          path: |
            ./artifacts

  build-deb:
    needs: flatpak
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev libjack-jackd2-dev

      - name: Cargo cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ./target
          key: deb-cargo-registry-${{ hashFiles('Cargo.lock') }}
      
      - name: Install cargo-deb
        run: cargo install cargo-deb

      - name: Build the binary
        run: cargo build --release --verbose

      - name: Build Debian package
        run: cargo deb

      - name: Archive Debian package
        uses: actions/upload-artifact@v4
        with:
          name: result-deb
          path: target/debian/*.deb

  deploy:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [flatpak, build, build-deb]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - name: List
        run: find ./artifacts
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
           files: |
            ./artifacts/*/*.tar.gz
            ./artifacts/*/*.zip
            ./artifacts/*/*.deb
            ./artifacts/*/*.flatpak
